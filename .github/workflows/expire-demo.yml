name: Demo Expiration Check

# This workflow automatically archives and makes the repository private after 30 days
# Expiration Date: 2024-12-24
# Created: 2024-11-24

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    # Allow manual triggering for testing

jobs:
  check-expiration:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Check expiration date
        id: check_date
        run: |
          EXPIRATION_DATE="2024-12-24"
          CURRENT_DATE=$(date +%Y-%m-%d)
          
          echo "Current date: $CURRENT_DATE"
          echo "Expiration date: $EXPIRATION_DATE"
          
          if [[ "$CURRENT_DATE" > "$EXPIRATION_DATE" ]] || [[ "$CURRENT_DATE" == "$EXPIRATION_DATE" ]]; then
            echo "expired=true" >> $GITHUB_OUTPUT
            echo "⚠️  Demo has expired!"
          else
            echo "expired=false" >> $GITHUB_OUTPUT
            echo "✓ Demo is still active"
            
            # Calculate days remaining
            DAYS_REMAINING=$(( ( $(date -d "$EXPIRATION_DATE" +%s) - $(date -d "$CURRENT_DATE" +%s) ) / 86400 ))
            echo "Days remaining: $DAYS_REMAINING"
          fi
      
      - name: Update README with expiration warning
        if: steps.check_date.outputs.expired == 'true'
        uses: actions/checkout@v3
        
      - name: Add expiration notice to README
        if: steps.check_date.outputs.expired == 'true'
        run: |
          # Create expiration notice
          cat > EXPIRED.md << 'EOF'
          # ⚠️ DEMO EXPIRED
          
          This demonstration project expired on 2024-12-24.
          
          ## Why Expired?
          
          This demo was created to showcase Snowflake features current as of November 2024. 
          To ensure users don't encounter outdated syntax or deprecated features, we automatically 
          archive demos after 30 days.
          
          ## What Now?
          
          - **For learning:** The code and documentation remain viewable (read-only)
          - **For updates:** Contact the Snowflake SE team for an updated version
          - **For production:** This was a reference implementation - review and customize for your needs
          
          ## Archived Content
          
          The original README and all documentation have been preserved in the repository history.
          
          ---
          
          **Original Created:** 2024-11-24  
          **Expired:** 2024-12-24  
          **Author:** SE Community
          EOF
          
          # Prepend expiration notice to README
          cat EXPIRED.md README.md > README.tmp
          mv README.tmp README.md
          
          # Update badges
          sed -i 's/Status-ACTIVE-green/Status-EXPIRED-red/g' README.md
          sed -i 's/Ready%20to%20Run-Yes-green/Ready%20to%20Run-No-red/g' README.md
      
      - name: Commit expiration notice
        if: steps.check_date.outputs.expired == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add README.md EXPIRED.md
          git commit -m "chore: mark demo as expired (automated)" || echo "No changes to commit"
          git push || echo "Nothing to push"
      
      - name: Archive repository
        if: steps.check_date.outputs.expired == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Archive the repository (make read-only)
          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }} \
            -f archived=true
          
          echo "✓ Repository archived (read-only)"
      
      - name: Make repository private
        if: steps.check_date.outputs.expired == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Make repository private
          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }} \
            -f private=true
          
          echo "✓ Repository made private"
      
      - name: Create expiration issue
        if: steps.check_date.outputs.expired == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create an issue to notify maintainers
          gh issue create \
            --title "Demo Expired - Repository Archived" \
            --body "This demo has reached its 30-day expiration date (2024-12-24) and has been automatically archived and made private. The repository is now read-only. If you need an updated version, please create a new demo with current Snowflake features." \
            --label "expired"
          
          echo "✓ Expiration issue created"

