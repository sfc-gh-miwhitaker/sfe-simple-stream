name: Expire Demo Repository

on:
  schedule:
    - cron: "0 12 * * *" # daily at 12:00 UTC
  workflow_dispatch: {}

permissions:
  contents: read
  issues: write

jobs:
  expire:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse expiration date from deploy_all.sql
        id: expiry
        shell: bash
        run: |
          python - <<'PY' >> "$GITHUB_OUTPUT"
          import datetime as dt
          import pathlib
          import re
          p = pathlib.Path("deploy_all.sql")
          text = p.read_text(encoding="utf-8", errors="replace")
          m = re.search(r"^\\s*\\*\\s*EXPIRES:\\s*(\\d{4}-\\d{2}-\\d{2})\\s*$", text, re.M)
          if not m:
            raise SystemExit("ERROR: Could not find header line '* EXPIRES: YYYY-MM-DD' in deploy_all.sql")
          expires = dt.date.fromisoformat(m.group(1))
          today = dt.date.today()
          days_remaining = (expires - today).days
          print(f"expires={expires.isoformat()}")
          print(f"days_remaining={days_remaining}")
          PY

      - name: Create expiration warning issue (7 days)
        if: ${{ steps.expiry.outputs.days_remaining != '' && fromJSON(steps.expiry.outputs.days_remaining) <= 7 && fromJSON(steps.expiry.outputs.days_remaining) > 1 }}
        uses: actions/github-script@v7
        with:
          script: |
            const expires = `${{ steps.expiry.outputs.expires }}`;
            const days = Number(`${{ steps.expiry.outputs.days_remaining }}`);
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const title = `Demo expires on ${expires}`;
            const body = [
              `This demonstration repository is timeboxed and will expire on ${expires}.`,
              ``,
              `Expiration is read from \\`deploy_all.sql\\` (single source of truth).`,
              ``,
              `Days remaining: ${days}`,
            ].join(\"\\n\");
            const { data: issues } = await github.rest.issues.listForRepo({ owner, repo, state: \"open\", per_page: 100 });
            if (issues.some(i => i.title === title)) return;
            await github.rest.issues.create({ owner, repo, title, body });

      - name: Create expiration warning issue (1 day)
        if: ${{ steps.expiry.outputs.days_remaining != '' && fromJSON(steps.expiry.outputs.days_remaining) == 1 }}
        uses: actions/github-script@v7
        with:
          script: |
            const expires = `${{ steps.expiry.outputs.expires }}`;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const title = `Demo expires tomorrow (${expires})`;
            const body = [
              `This demonstration repository expires tomorrow (${expires}).`,
              ``,
              `Expiration is read from \\`deploy_all.sql\\` (single source of truth).`,
            ].join(\"\\n\");
            const { data: issues } = await github.rest.issues.listForRepo({ owner, repo, state: \"open\", per_page: 100 });
            if (issues.some(i => i.title === title)) return;
            await github.rest.issues.create({ owner, repo, title, body });

      - name: Create expires-today issue
        if: ${{ steps.expiry.outputs.days_remaining != '' && fromJSON(steps.expiry.outputs.days_remaining) == 0 }}
        uses: actions/github-script@v7
        with:
          script: |
            const expires = `${{ steps.expiry.outputs.expires }}`;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const title = `Demo expires today (${expires})`;
            const body = [
              `This demonstration repository expires today (${expires}).`,
              ``,
              `Expiration is read from \\`deploy_all.sql\\` (single source of truth).`,
            ].join(\"\\n\");
            const { data: issues } = await github.rest.issues.listForRepo({ owner, repo, state: \"open\", per_page: 100 });
            if (issues.some(i => i.title === title)) return;
            await github.rest.issues.create({ owner, repo, title, body });

      - name: Create expired issue
        if: ${{ steps.expiry.outputs.days_remaining != '' && fromJSON(steps.expiry.outputs.days_remaining) < 0 }}
        uses: actions/github-script@v7
        with:
          script: |
            const expires = `${{ steps.expiry.outputs.expires }}`;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const title = `Demo expired on ${expires}`;
            const body = [
              `This demonstration repository has expired (expired on ${expires}).`,
              ``,
              `Deployment is blocked by \\`deploy_all.sql\\`.`,
              ``,
              `Next step: archive the repository and make it private (if required by policy).`,
            ].join(\"\\n\");
            const { data: issues } = await github.rest.issues.listForRepo({ owner, repo, state: \"open\", per_page: 100 });
            if (issues.some(i => i.title === title)) return;
            await github.rest.issues.create({ owner, repo, title, body });

      - name: Attempt archive + make private (requires MASTER_PAT)
        if: ${{ steps.expiry.outputs.days_remaining != '' && fromJSON(steps.expiry.outputs.days_remaining) < 0 }}
        shell: bash
        env:
          MASTER_PAT: ${{ secrets.MASTER_PAT }}
        run: |
          if [ -z "${MASTER_PAT}" ]; then
            echo "MASTER_PAT not set; skipping archive/private attempt."
            exit 0
          fi
          owner="${GITHUB_REPOSITORY%/*}"
          repo="${GITHUB_REPOSITORY#*/}"
          curl -sSf \
            -X PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${MASTER_PAT}" \
            "https://api.github.com/repos/${owner}/${repo}" \
            -d '{"archived":true,"private":true}' >/dev/null
          echo "Archive/private request sent."
