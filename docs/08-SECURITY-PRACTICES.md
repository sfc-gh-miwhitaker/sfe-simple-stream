# Security Practices

**Author:** SE Community
**Last Updated:** 2025-12-02
**Expires:** 2026-02-05

![Snowflake](https://img.shields.io/badge/Snowflake-29B5E8?style=for-the-badge&logo=snowflake&logoColor=white)

Reference Implementation: This code demonstrates production-grade architectural patterns and best practices. Review and customize security, networking, and logic for your organization's specific requirements before deployment.

---

## Secrets Directory (.secrets/)

The `.secrets/` directory is auto-generated by setup scripts and contains:

| File | Contains | Risk Level |
|------|----------|------------|
| `.secrets/config.json` | Account ID, username, database | HIGH |
| `.secrets/configure_auth_READY.sql` | Public key embedded in SQL | MEDIUM |
| `.secrets/keys/rsa_key.p8` | Private key | CRITICAL |
| `.secrets/keys/rsa_key.pub` | Public key | LOW |

**This directory is NEVER committed to Git.**

---

## Automatic Protection

Setup scripts automatically:
1. Create `.secrets/` directory
2. Add to `.git/info/exclude`
3. Display security warning
4. Verify not staged before exit

---

## Manual Verification

Before any commit:

```bash
# Check staging area
git status

# Verify .secrets/ not included
git diff --cached --name-only | grep ".secrets"  # Should return nothing
```

---

## If Credentials Are Exposed

**Immediate actions:**
1. Disable the Snowflake user immediately
2. Rotate all credentials (new key pair, new user)
3. Check Snowflake access logs for unauthorized activity
4. Make repository private (if public)
5. Purge from Git history using BFG Repo-Cleaner
6. Notify security team

**Git history cleanup:**
```bash
# Install BFG Repo-Cleaner
brew install bfg

# Remove .secrets/ from all commits
bfg --delete-folders .secrets --no-blob-protection

# Rewrite history
git reflog expire --expire=now --all
git gc --prune=now --aggressive

# Force push (coordinate with team)
git push --force
```

**Snowflake actions:**
```sql
-- Disable compromised user immediately
USE ROLE SECURITYADMIN;
ALTER USER SFE_INGEST_USER SET DISABLED = TRUE;

-- Check access logs for unauthorized activity
USE ROLE ACCOUNTADMIN;
SELECT
  user_name,
  client_ip,
  event_type,
  event_timestamp,
  query_text
FROM SNOWFLAKE.ACCOUNT_USAGE.QUERY_HISTORY
WHERE user_name = 'SFE_INGEST_USER'
  AND event_timestamp >= DATEADD(day, -1, CURRENT_TIMESTAMP())
ORDER BY event_timestamp DESC;

-- After creating new keys, drop the old user
DROP USER IF EXISTS SFE_INGEST_USER;
```

---

## Best Practices

### Do's OK
- Always run setup script (don't create secrets manually)
- Verify warnings display during setup
- Check `.git/info/exclude` contains `.secrets/` pattern
- Use environment variables for sensitive data
- Rotate credentials regularly (every 90 days)
- Use global gitignore for defense-in-depth

### Don'ts NOT
- Never manually add `.secrets/` to Git
- Never create `.gitignore` files (use global ignore for stealth)
- Never commit credentials, keys, or account identifiers
- Never share `.secrets/` directory contents
- Never hardcode credentials in code or SQL
- Never bypass security warnings

---

## Related Documentation

- [`01-SETUP.md`](01-SETUP.md) - Initial setup process
- [`03-TESTING.md`](03-TESTING.md) - Testing with generated credentials
- [`06-DATA-PROVIDER-QUICKSTART.md`](06-DATA-PROVIDER-QUICKSTART.md) - External vendor handoff

---

## Compliance

This project follows Snowflake SE security standards:
- No credentials in version control
- Stealth mode (no `.gitignore` files)
- Global ignore patterns (`~/dotfiles/git/gitignore_global`)
- Automated protection via `.git/info/exclude`
- SE Community attribution (no personal names)

---

## Contact

For security incidents or questions:
- Disable user immediately
- Rotate credentials
- Report to security team
- Document incident in an internal/private incident record (do not commit credentials, tokens, or incident artifacts to this repository)
